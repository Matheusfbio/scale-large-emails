{% extends "hello/layout.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Lista de Emails{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'hello/email_list.css' %}">

<div class="email-list-container">
    <div class="container">
        <!-- Filtros -->
        <div class="filters-section">
            <div class="filters-content">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="emailSearch" class="search-input" placeholder="Buscar por remetente ou assunto...">
                </div>
                
                <div class="filter-controls">
                    <select id="categoryFilter" class="filter-select">
                        <option value="">Todas as categorias</option>
                        <option value="produtivo">Produtivo</option>
                        <option value="improdutivo">Improdutivo</option>
                    </select>
                    
                    <select id="confidenceFilter" class="filter-select">
                        <option value="">Todos os níveis</option>
                        <option value="high">Alta confiança (80%+)</option>
                        <option value="medium">Média confiança (40-79%)</option>
                        <option value="low">Baixa confiança (0-39%)</option>
                    </select>
                    
                    <button id="clearFilters" class="btn-clear">
                        <i class="fas fa-times me-2"></i>Limpar Filtros
                    </button>
                </div>
            </div>
        </div>

        {% if emails %}
            <div class="emails-table-container">
                <div class="table-header">
                    <div class="table-title">
                        <h3><i class="fas fa-list me-2"></i>Lista de Emails</h3>
                        <span class="email-count">{{ emails|length }} emails encontrados</span>
                    </div>
                    <div class="table-actions">
                        <button class="btn-modern btn-outline-modern" id="exportData">
                            <i class="fas fa-download me-2"></i>
                            Exportar Dados
                        </button>
                    </div>
                </div>
                
                <div class="emails-table">
                    {% for email in emails %}
                    <div class="email-row" 
                         data-category="{{ email.category }}" 
                         data-confidence="{{ email.confidence_score|multiply:100|floatformat:0 }}">
                        <div class="email-sender">
                            <div class="sender-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="sender-info">
                                <div class="sender-email">{{ email.sender }}</div>
                                <div class="email-date">{{ email.received_date|date:"d/m/Y H:i" }}</div>
                            </div>
                        </div>
                        
                        <div class="email-subject">
                            <div class="subject-text">{{ email.subject }}</div>
                            <div class="email-preview">{{ email.content|truncatechars:100 }}</div>
                        </div>
                        
                        <div class="email-category">
                            <span class="category-badge {% if email.category == 'produtivo' %}productive{% else %}unproductive{% endif %}">
                                <i class="fas {% if email.category == 'produtivo' %}fa-check-circle{% else %}fa-times-circle{% endif %} me-2"></i>
                                {{ email.category|title }}
                            </span>
                        </div>
                        
                        <div class="email-confidence">
                            <div class="confidence-bar">
                                <div class="confidence-fill 
                                            {% with confidence_percent=email.confidence_score|multiply:100|floatformat:0 %}
                                                {% if confidence_percent >= 80 %}high-confidence
                                                {% elif confidence_percent >= 60 %}medium-high-confidence
                                                {% elif confidence_percent >= 40 %}medium-confidence
                                                {% elif confidence_percent >= 20 %}low-medium-confidence
                                                {% else %}low-confidence{% endif %}
                                            {% endwith %}" 
                                     style="width: {{ email.confidence_score|multiply:100|floatformat:0 }}%"></div>
                            </div>
                            <div class="confidence-text">{{ email.confidence_score|multiply:100|floatformat:1 }}%</div>
                        </div>
                        
                        <div class="email-actions">
                            <button class="action-btn view-btn" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#emailModal{{ email.id }}"
                                    title="Ver Detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn copy-btn" 
                                    onclick="copyResponse('{{ email.suggested_response|escapejs }}')"
                                    title="Copiar Resposta">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="action-btn more-btn" title="Mais Opções">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Modal igual, sem alterações -->
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <!-- Empty state igual -->
        {% endif %}
    </div>
</div>

<script>
// Ao carregar a página, apenas mostra os dados, sem filtrar
document.addEventListener('DOMContentLoaded', function() {
    calculateStatistics();
    setupEventListeners();
    addLoadingStates();
    addSmoothAnimations();
    // REMOVIDO filterEmails() aqui
});

function setupEventListeners() {
    const searchInput = document.getElementById('emailSearch');
    const categoryFilter = document.getElementById('categoryFilter');
    const confidenceFilter = document.getElementById('confidenceFilter');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const emailRows = document.querySelectorAll('.email-row');

    function filterEmails() {
        const searchTerm = searchInput.value.toLowerCase();
        const categoryValue = categoryFilter.value;
        const confidenceValue = confidenceFilter.value;

        emailRows.forEach((row, index) => {
            const sender = row.querySelector('.sender-email').textContent.toLowerCase();
            const subject = row.querySelector('.subject-text').textContent.toLowerCase();
            const category = row.dataset.category;
            const confidence = parseFloat(row.dataset.confidence); // já em %

            let showRow = true;

            // Filtro de busca
            if (searchTerm && !sender.includes(searchTerm) && !subject.includes(searchTerm)) {
                showRow = false;
            }

            // Filtro de categoria
            if (categoryValue && category !== categoryValue) {
                showRow = false;
            }

            // Filtro de confiança
            if (confidenceValue) {
                if (confidenceValue === 'high' && confidence < 80) showRow = false;
                else if (confidenceValue === 'medium' && (confidence < 40 || confidence >= 80)) showRow = false;
                else if (confidenceValue === 'low' && confidence >= 40) showRow = false;
            }

            row.style.display = showRow ? 'grid' : 'none';
            if (showRow) {
                row.style.animationDelay = `${index * 0.1}s`;
                row.classList.add('fade-in');
            }
        });

        updateEmailCount();
    }

    function updateEmailCount() {
        const visibleEmails = document.querySelectorAll('.email-row[style="display: grid"]').length;
        const countElement = document.querySelector('.email-count');
        if (countElement) {
            countElement.textContent = `${visibleEmails} emails encontrados`;
        }
    }

    // Event listeners
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(filterEmails, 300);
    });
    
    categoryFilter.addEventListener('change', filterEmails);
    confidenceFilter.addEventListener('change', filterEmails);
    
    clearFiltersBtn.addEventListener('click', function() {
        searchInput.value = '';
        categoryFilter.value = '';
        confidenceFilter.value = '';
        filterEmails();
        
        this.innerHTML = '<i class="fas fa-check me-2"></i>Filtros Limpos!';
        setTimeout(() => {
            this.innerHTML = '<i class="fas fa-times me-2"></i>Limpar Filtros';
        }, 2000);
    });

    document.getElementById('exportData').addEventListener('click', function() {
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Exportando...';
        setTimeout(() => {
            this.innerHTML = '<i class="fas fa-download me-2"></i>Exportar Dados';
            showNotification('Funcionalidade de exportação será implementada em breve!', 'info');
        }, 2000);
    });
}
</script>

<style>
/* Garante que todos aparecem inicialmente */
.email-row {
    display: grid;
}

/* Classes para diferentes níveis de confiança */
.confidence-fill.low-confidence {
  background: #dc3545 !important;
}

.confidence-fill.low-medium-confidence {
  background: linear-gradient(90deg, #dc3545, #fd7e14) !important;
}

.confidence-fill.medium-confidence {
  background: #ffc107 !important;
}

.confidence-fill.medium-high-confidence {
  background: linear-gradient(90deg, #ffc107, #28a745) !important;
}

.confidence-fill.high-confidence {
  background: #28a745 !important;
}
</style>
{% endblock %}
